<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Cliente - FR Consórcio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        .sidebar {
            width: 250px;
            background-color: #007BFF;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar.hidden {
            transform: translateX(-220px);
        }
        .sidebar .toggle-sidebar-button {
            position: absolute;
            top: 10px;
            right: -40px;
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: right 0.3s ease;
        }
        .sidebar.hidden .toggle-sidebar-button {
            right: -40px;
        }
        .sidebar h2 {
            margin: 0;
            margin-bottom: 20px;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            margin: 10px 0;
            width: 100%;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .sidebar a:hover {
            background-color: #0056b3;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            width: 100%;
            transition: margin-left 0.3s ease;
            overflow-y: auto;
        }
        .header {
            background-color: #fff;
            padding: 10px 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header .user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header .user-info i {
            font-size: 2em;
            color: #007BFF;
        }
        .header .user-info span {
            margin-top: 5px;
            font-size: 1em;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
        }
        .cliente-detalhes {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .cliente-detalhes .info-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .cliente-detalhes .info-group label {
            font-weight: bold;
            color: #333;
        }
        .cliente-detalhes .info-group span {
            color: #555;
        }
        .cliente-detalhes .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .cliente-detalhes .actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .cliente-detalhes .actions button.edit {
            background-color: #007BFF;
            color: white;
        }
        .cliente-detalhes .actions button.edit:hover {
            background-color: #0056b3;
        }
        .cliente-detalhes .actions button.delete {
            background-color: #FF0000;
            color: white;
        }
        .cliente-detalhes .actions button.delete:hover {
            background-color: #cc0000;
        }
        .cliente-detalhes .actions button.venda,
        .cliente-detalhes .actions button.boleto,
        .cliente-detalhes .actions button.lance {
            background-color: #28a745;
            color: white;
        }
        .cliente-detalhes .actions button.venda:hover,
        .cliente-detalhes .actions button.boleto:hover,
        .cliente-detalhes .actions button.lance:hover {
            background-color: #218838;
        }
        .modifications, .sales {
            margin-top: 20px;
        }
        .modifications h3, .sales h3 {
            margin-bottom: 10px;
        }
        .modifications ul, .sales ul {
            list-style-type: none;
            padding: 0;
        }
        .modifications ul li, .sales ul li {
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modifications ul li .delete-note {
            background: none;
            border: none;
            color: #FF0000;
            cursor: pointer;
            font-size: 1.2em;
        }
        .notes {
            margin-top: 20px;
        }
        .notes textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
        .notes input[type="file"] {
            margin-top: 10px;
        }
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .sales-table th, .sales-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .sales-table th {
            background-color: #f2f2f2;
            color: #333;
        }
        .sales-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .sales-table tr:hover {
            background-color: #f1f1f1;
        }
    </style>
    <!-- Adicione os scripts do Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD_YXnid23lFBvvMftPOA8A9iqCMi6Uejs",
            authDomain: "gescon-684aa.firebaseapp.com",
            projectId: "gescon-684aa",
            storageBucket: "gescon-684aa.appspot.com",
            messagingSenderId: "854894210731",
            appId: "1:854894210731:web:8fb476fbcb76bd7ec291ee",
            measurementId: "G-RZKSQ0HPGL"
        };
    
        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
    
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // Usuário está autenticado, buscar vendas
                const cpf = localStorage.getItem('cpfCliente');
            } else {
                // Redirecionar para a página de login se o usuário não estiver autenticado
                window.location.href = 'login.html';
            }
        });
    
        document.addEventListener('DOMContentLoaded', () => {
            // Recuperar dados do localStorage
            const cpf = localStorage.getItem('cpfCliente');
            const nome = localStorage.getItem('nomeCompletoCliente');
            const telefone = localStorage.getItem('telefoneCliente');
            const endereco = localStorage.getItem('enderecoCliente');
    
            // Exibir dados na página
            document.getElementById('clienteCpf').innerText = cpf;
            document.getElementById('clienteNome').innerText = nome;
            document.getElementById('clienteTelefone').innerText = telefone;
            document.getElementById('clienteEndereco').innerText = endereco;
    
            // Buscar e exibir vendas
            buscarVendas(cpf);
    
            document.getElementById('salvarAnotacaoBtn').addEventListener('click', () => {
                const anotacao = document.getElementById('anotacoes').value;
                if (anotacao.trim() !== '') {
                    salvarAnotacao(cpf, anotacao);
                } else {
                    alert('Por favor, escreva uma anotação.');
                }
            });
    
            document.getElementById('anexos').addEventListener('change', (event) => {
                const arquivos = event.target.files;
                if (arquivos.length > 0) {
                    for (const arquivo of arquivos) {
                        salvarArquivo(cpf, arquivo);
                    }
                }
            });
        });
    
        async function buscarVendas(cpf) {
            try {
                const salesList = document.getElementById('salesList');
                salesList.innerHTML = ''; // Limpar a lista antes de adicionar novos itens
    
                const vendasSnapshot = await db.collection('clientes').doc(cpf).collection('vendas').get();
                vendasSnapshot.forEach(doc => {
                    const venda = doc.data();
                    const vendedor = venda.vendedor || 'N/A';
                    const administradora = venda.administradora || 'N/A';
                    const produto = venda.produto || 'N/A';
                    const valor = venda.valorCredito !== undefined ? venda.valorCredito : 0;
                    const dataHoraCadastro = venda.dataHoraCadastro ? new Date(venda.dataHoraCadastro.seconds * 1000).toLocaleString() : 'N/A';
    
                    const formattedValue = `R$ ${valor.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&.').replace(/\.(\d{2})$/, ',$1')}`;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${vendedor}</td>
                        <td>${administradora}</td>
                        <td>${produto}</td>
                        <td>${formattedValue}</td>
                        <td>${dataHoraCadastro}</td>
                    `;
                    salesList.appendChild(tr);
                });
            } catch (error) {
                console.error('Erro ao buscar vendas:', error);
            }
        }

        async function salvarAnotacao(cpf, anotacao) {
            try {
                await db.collection('clientes').doc(cpf).collection('anotacoes').add({
                    anotacao: anotacao,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Anotação salva com sucesso!');
                location.reload(); // Recarregar a página para atualizar a lista de anotações
            } catch (error) {
                console.error('Erro ao salvar anotação:', error);
                alert('Erro ao salvar anotação. Tente novamente.');
            }
        }

        async function salvarArquivo(cpf, arquivo) {
            try {
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`clientes/${cpf}/${arquivo.name}`);
                await fileRef.put(arquivo);
                const fileURL = await fileRef.getDownloadURL();
                await db.collection('clientes').doc(cpf).collection('arquivos').add({
                    nome: arquivo.name,
                    url: fileURL,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Arquivo salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar arquivo:', error);
                alert('Erro ao salvar arquivo. Tente novamente.');
            }
        }

        function registrarVenda() {
            window.location.href = 'registrar_venda.html';
        }

        function editarCliente() {
            const cpf = localStorage.getItem('cpfCliente');
            window.location.href = `editar_cliente.html?cpf=${cpf}`;
        }

        async function atualizarEtapaFunil(event) {
            event.preventDefault();
            const cpf = localStorage.getItem('cpfCliente');
            const funnelStage = document.getElementById('funnelStage').value;

            try {
                await db.collection('clientes').doc(cpf).update({
                    etapaFunil: funnelStage
                });
                alert('Etapa do funil atualizada com sucesso!');
            } catch (error) {
                console.error('Erro ao atualizar etapa do funil:', error);
                alert('Erro ao atualizar etapa do funil. Tente novamente.');
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }
    </script>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <button class="toggle-sidebar-button" onclick="toggleSidebar()">☰</button>
        <h2>FR Consórcio</h2>
        <a href="dashboard.html">Home</a>
        <a href="cadastro_cliente.html">Cadastrar Cliente</a>
        <a href="consultar_cliente.html">Consultar Cliente</a>
        <a href="relatorio_vendas.html">Relatório Vendas</a>
        <a href="relatorio_marketing.html">Relatório de Marketing</a>
        <a href="gerenciamento_leads.html">Gerenciamento de Leads</a>
        <a href="#">Relatório de Clientes</a>
        <a href="#">Emitir Boletos</a>
        <a href="#">Lançar Lance em Lote</a>
        <a href="#">Cadastrar Usuário</a>
    </div>
    <div class="main-content" id="mainContent">
        <div class="header">
            <div class="info-cards">
                <div class="info-card">
                    <h2>Detalhes do Cliente</h2>
                </div>
            </div>
            <div class="user-info">
                <a href="gerenciar_dados.html" class="profile-link">
                    <img src="user-avatar.jpeg" alt="Perfil" style="width: 40px; height: 40px; border-radius: 50%;">
                    <br>
                    <span id="userName">Nome do Usuário</span> <!-- Nome inicial será atualizado pelo Firebase -->
                </a>
            </div>
        </div>
        <div class="container">
            <h2>Detalhes do Cliente</h2>
            <div class="cliente-detalhes">
                <div class="info-group">
                    <label>Nome Completo:</label>
                    <span id="clienteNome"></span>
                </div>
                <div class="info-group">
                    <label>CPF:</label>
                    <span id="clienteCpf"></span>
                </div>
                <div class="info-group">
                    <label>Telefone:</label>
                    <span id="clienteTelefone"></span>
                </div>
                <div class="info-group">
                    <label>Endereço:</label>
                    <span id="clienteEndereco"></span>
                </div>
                <div class="info-group">
                    <label>Etapa no Funil:</label>
                    <form id="funnelStageForm" onsubmit="atualizarEtapaFunil(event)">
                        <select id="funnelStage" name="funnelStage" required>
                            <option value="Lead">Lead</option>
                            <option value="Contato Realizado">Contato Realizado</option>
                            <option value="Proposta Enviada">Proposta Enviada</option>
                            <option value="Negociação">Negociação</option>
                            <option value="Fechamento">Fechamento</option>
                        </select>
                        <button type="submit">Atualizar</button>
                    </form>
                </div>
                <div class="sales">
                    <h3>Vendas Emitidas</h3>
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>Vendedor</th>
                                <th>Administradora</th>
                                <th>Produto</th>
                                <th>Valor</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="salesList"></tbody>
                    </table>
                </div>
                <div class="notes">
                    <h3>Anotações</h3>
                    <textarea id="anotacoes" placeholder="Escreva suas anotações aqui..."></textarea>
                    <button id="salvarAnotacaoBtn" class="btn-submit">Salvar Anotação</button>
                    <input type="file" id="anexos" multiple>
                    <ul id="notesList"></ul>
                </div>
                <div class="actions">
                    <button class="edit" onclick="editarCliente()">Editar</button>
                    <button class="delete">Excluir</button>
                    <button class="venda" onclick="registrarVenda()">Registrar Venda</button>
                    <button class="boleto">Emitir Boleto</button>
                    <button class="lance">Lançar Lance</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>