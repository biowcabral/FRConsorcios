<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Marketing - FR Consórcio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: none; /* Ocultar o conteúdo por padrão */
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .chart-container {
            margin-bottom: 40px;
        }
        .chart-container canvas {
            width: 100%;
            height: 400px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .form-container {
            margin-bottom: 40px;
        }
        .form-container input, .form-container select, .form-container button {
            padding: 10px;
            margin: 5px;
        }
        .button-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .button-container button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .login-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .login-container input, .login-container button {
            padding: 10px;
            margin: 5px;
        }
        .no-access {
            color: red;
            font-size: 18px;
            text-align: center;
            display: none; /* Ocultar a mensagem de acesso negado por padrão */
        }
    </style>
</head>
<body>
    <div class="container" id="contentContainer">
        <h1>Relatório de Marketing</h1>

        <!-- Formulário de Login -->
        <div class="login-container" id="loginContainer">
            <h2>Login</h2>
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Senha" required>
            <button id="loginButton">Login</button>
            <div id="loginError" style="color: red;"></div>
        </div>

        <!-- Botões para alternar entre visualização semanal e mensal -->
        <div class="button-container" id="buttonContainer">
            <button id="weeklyButton">Relatório Semanal</button>
            <button id="monthlyButton">Relatório Mensal</button>
        </div>

        <!-- Formulário para Inserção de Dados -->
        <div class="form-container" id="formContainer">
            <h2>Inserir Dados de Marketing</h2>
            <form id="marketingForm">
                <input type="week" id="semana" required>
                <input type="number" step="0.01" id="investimento" placeholder="Investimento (R$)" required>
                <input type="number" id="cadastros" placeholder="Número de Cadastros" required>
                <input type="number" id="vendas" placeholder="Número de Vendas" required> <!-- Novo campo -->
                <input type="number" step="0.01" id="cpm" placeholder="Custo por Mil Impressões (CPM) (R$)" required>
                <input type="number" step="0.01" id="ctr" placeholder="Taxa de Clique no Link (CTR) (%)" required>
                <input type="number" step="0.01" id="valorVenda" placeholder="Valor de Venda (R$)" required>
                <select id="vendedor" required>
                    <option value="">Selecione o Vendedor</option>
                    <!-- Adicione opções de vendedores aqui -->
                    <option value="vendedor1">Vendedor 1</option>
                    <option value="vendedor2">Vendedor 2</option>
                </select>
                <button type="submit">Adicionar Dados</button>
            </form>
        </div>

        <!-- Gráficos -->
        <div class="chart-container" id="chartContainer1">
            <h2>Investimento por Semana/Mês</h2>
            <canvas id="investimentoChart"></canvas>
        </div>

        <div class="chart-container" id="chartContainer2">
            <h2>Número de Cadastros por Semana/Mês</h2>
            <canvas id="cadastrosChart"></canvas>
        </div>

        <div class="chart-container" id="chartContainer3">
            <h2>Custo por Cadastro por Semana/Mês</h2>
            <canvas id="custoCadastroChart"></canvas>
        </div>

        <div class="chart-container" id="chartContainer4">
            <h2>Custo por Mil Impressões (CPM) por Semana/Mês</h2>
            <canvas id="cpmChart"></canvas>
        </div>

        <div class="chart-container" id="chartContainer5">
            <h2>Taxa de Clique no Link (CTR) por Semana/Mês</h2>
            <canvas id="ctrChart"></canvas>
        </div>

        <div class="chart-container" id="chartContainer6">
            <h2>Valor de Venda por Semana/Mês</h2>
            <canvas id="valorVendaChart"></canvas>
        </div>

        <div class="chart-container" id="chartContainer7">
            <h2>Taxa de Conversão por Semana/Mês</h2>
            <canvas id="taxaConversaoChart"></canvas>
        </div>
    </div>

    <!-- Mensagem de Acesso Negado -->
    <div id="noAccess" class="no-access">
        <p>Você não tem permissão para acessar esta página.</p>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD_YXnid23lFBvvMftPOA8A9iqCMi6Uejs",
            authDomain: "gescon-684aa.firebaseapp.com",
            projectId: "gescon-684aa",
            storageBucket: "gescon-684aa.appspot.com",
            messagingSenderId: "854894210731",
            appId: "1:854894210731:web:8fb476fbcb76bd7ec291ee",
            measurementId: "G-RZKSQ0HPGL"
        };
    
        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    
        // Função para criar gráficos
        function createChart(ctx, type, data, label) {
            return new Chart(ctx, {
                type: type,
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: label,
                        data: data.values,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: 'black',
                            font: {
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
    
        // Função para atualizar os gráficos com novos dados
        function updateCharts(data) {
            investimentoChart.data.labels = data.labels;
            investimentoChart.data.datasets[0].data = data.investimento;
            investimentoChart.update();
    
            cadastrosChart.data.labels = data.labels;
            cadastrosChart.data.datasets[0].data = data.cadastros;
            cadastrosChart.update();
    
            custoCadastroChart.data.labels = data.labels;
            custoCadastroChart.data.datasets[0].data = data.custoCadastro;
            custoCadastroChart.update();
    
            cpmChart.data.labels = data.labels;
            cpmChart.data.datasets[0].data = data.cpm;
            cpmChart.update();
    
            ctrChart.data.labels = data.labels;
            ctrChart.data.datasets[0].data = data.ctr;
            ctrChart.update();
    
            valorVendaChart.data.labels = data.labels;
            valorVendaChart.data.datasets[0].data = data.valorVenda;
            valorVendaChart.update();
    
            taxaConversaoChart.data.labels = data.labels;
            taxaConversaoChart.data.datasets[0].data = data.taxaConversao;
            taxaConversaoChart.update();
        }
    
        // Criar gráficos
        const investimentoChart = createChart(document.getElementById('investimentoChart'), 'bar', { labels: [], values: [] }, 'Investimento (R$)');
        const cadastrosChart = createChart(document.getElementById('cadastrosChart'), 'bar', { labels: [], values: [] }, 'Número de Cadastros');
        const custoCadastroChart = createChart(document.getElementById('custoCadastroChart'), 'bar', { labels: [], values: [] }, 'Custo por Cadastro (R$)');
        const cpmChart = createChart(document.getElementById('cpmChart'), 'bar', { labels: [], values: [] }, 'Custo por Mil Impressões (CPM) (R$)');
        const ctrChart = createChart(document.getElementById('ctrChart'), 'bar', { labels: [], values: [] }, 'Taxa de Clique no Link (CTR) (%)');
        const valorVendaChart = createChart(document.getElementById('valorVendaChart'), 'bar', { labels: [], values: [] }, 'Valor de Venda (R$)');
        const taxaConversaoChart = createChart(document.getElementById('taxaConversaoChart'), 'bar', { labels: [], values: [] }, 'Taxa de Conversão (%)');
    
        // Função para mostrar elementos após login
        function showElementsAfterLogin() {
            document.getElementById('contentContainer').style.display = 'block';
            document.querySelector('.login-container').style.display = 'none';
        }
    
        // Manipular o login
        document.getElementById('loginButton').addEventListener('click', async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
    
            try {
                await auth.signInWithEmailAndPassword(email, password);
                const user = auth.currentUser;
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists && doc.data().role === 'admin') {
                    showElementsAfterLogin();
                    loadData('semanal'); // Carregar dados semanais por padrão
                } else {
                    window.location.href = 'dashboard.html'; // Redireciona para a página padrão
                }
            } catch (error) {
                document.getElementById('loginError').textContent = "Erro ao fazer login: " + error.message;
            }
        });
    
        // Atualizar gráficos ao clicar nos botões
        document.getElementById('weeklyButton').addEventListener('click', function() {
            loadData('semanal');
        });
    
        document.getElementById('monthlyButton').addEventListener('click', function() {
            loadData('mensal');
        });
    
        // Manipular o envio do formulário
        document.getElementById('marketingForm').addEventListener('submit', async function(event) {
            event.preventDefault();
        
            const semana = document.getElementById('semana').value;
            const investimento = parseFloat(document.getElementById('investimento').value);
            const cadastros = parseInt(document.getElementById('cadastros').value);
            const vendas = parseInt(document.getElementById('vendas').value); // Novo campo
            const custoCadastro = investimento / cadastros;
            const cpm = parseFloat(document.getElementById('cpm').value);
            const ctr = parseFloat(document.getElementById('ctr').value);
            const valorVenda = parseFloat(document.getElementById('valorVenda').value);
            const taxaConversao = (vendas / cadastros) * 100; // Cálculo da taxa de conversão
        
            // Obter a data da segunda-feira da semana selecionada
            const mondayDate = getMonday(semana);
        
            // Salvar dados no Firestore com ID personalizado
            await db.collection('marketing').doc(mondayDate.toISOString().split('T')[0]).set({
                semana: mondayDate.toISOString().split('T')[0],
                investimento,
                cadastros,
                vendas, // Novo campo
                custoCadastro,
                cpm,
                ctr,
                valorVenda,
                taxaConversao
            });
        
            // Recarregar dados e atualizar gráficos
            const viewMode = document.querySelector('.button-container button.active')?.id === 'weeklyButton' ? 'semanal' : 'mensal';
            loadData(viewMode);
            
            // Limpar formulário
            document.getElementById('marketingForm').reset();
            });
            
            // Função para carregar dados do Firestore e atualizar os gráficos
            async function loadData(viewMode) {
                let snapshot;
                const data = {
                    labels: [],
                    investimento: [],
                    cadastros: [],
                    vendas: [], // Novo campo
                    custoCadastro: [],
                    cpm: [],
                    ctr: [],
                    valorVenda: [],
                    taxaConversao: []
                };
            
                if (viewMode === 'mensal') {
                    snapshot = await db.collection('marketing').get();
                    const monthlyData = {};
            
                    snapshot.forEach(doc => {
                        const docData = doc.data();
                        const month = docData.semana.substring(0, 7); // Extrair ano e mês
            
                        if (!monthlyData[month]) {
                            monthlyData[month] = {
                                investimento: 0,
                                cadastros: 0,
                                vendas: 0, // Novo campo
                                custoCadastro: 0,
                                cpm: 0,
                                ctr: 0,
                                valorVenda: 0,
                                count: 0
                            };
                        }
            
                        monthlyData[month].investimento += docData.investimento ?? 0;
                        monthlyData[month].cadastros += docData.cadastros ?? 0;
                        monthlyData[month].vendas += docData.vendas ?? 0; // Novo campo
                        monthlyData[month].custoCadastro += docData.custoCadastro ?? 0;
                        monthlyData[month].cpm += docData.cpm ?? 0;
                        monthlyData[month].ctr += docData.ctr ?? 0;
                        monthlyData[month].valorVenda += docData.valorVenda ?? 0;
                        monthlyData[month].count += 1;
                    });
            
                    for (const month in monthlyData) {
                        data.labels.push(formatMonthYear(month));
                        data.investimento.push(monthlyData[month].investimento);
                        data.cadastros.push(monthlyData[month].cadastros);
                        data.vendas.push(monthlyData[month].vendas); // Novo campo
                        data.custoCadastro.push(monthlyData[month].custoCadastro / monthlyData[month].count);
                        data.cpm.push(monthlyData[month].cpm / monthlyData[month].count);
                        data.ctr.push((monthlyData[month].ctr / monthlyData[month].count).toFixed(2)); // Formatar com 2 casas decimais
                        data.valorVenda.push(monthlyData[month].valorVenda);
                        data.taxaConversao.push(((monthlyData[month].vendas / monthlyData[month].cadastros) * 100).toFixed(2)); // Formatar com 2 casas decimais
                    }
                } else {
                    snapshot = await db.collection('marketing').orderBy('semana').get();
            
                    snapshot.forEach(doc => {
                        const docData = doc.data();
                        data.labels.push(docData.semana);
                        data.investimento.push(docData.investimento ?? 0);
                        data.cadastros.push(docData.cadastros ?? 0);
                        data.vendas.push(docData.vendas ?? 0); // Novo campo
                        data.custoCadastro.push(docData.custoCadastro ?? 0);
                        data.cpm.push(docData.cpm ?? 0);
                        data.ctr.push((docData.ctr ?? 0).toFixed(2)); // Formatar com 2 casas decimais
                        data.valorVenda.push(docData.valorVenda ?? 0);
                        data.taxaConversao.push(((docData.vendas / docData.cadastros) * 100).toFixed(2)); // Formatar com 2 casas decimais
                    });
                }
            
                updateCharts(data);
            }
            
            // Função para formatar a data no formato "Agosto-2024"
            function formatMonthYear(dateString) {
                const [year, month] = dateString.split("-");
                const date = new Date(year, month - 1);
                const options = { year: 'numeric', month: 'long' };
                return date.toLocaleDateString('pt-BR', options);
            }
            
            // Função para obter a data da segunda-feira de uma semana
            function getMonday(weekString) {
                const [year, week] = weekString.split('-W');
                const firstDayOfYear = new Date(year, 0, 1);
                const daysOffset = (week - 1) * 7;
                const monday = new Date(firstDayOfYear.setDate(firstDayOfYear.getDate() + daysOffset));
                const dayOfWeek = monday.getDay();
                const diff = monday.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                return new Date(monday.setDate(diff));
            }
    
        // Verificar se o usuário está logado ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const doc = await db.collection('users').doc(user.uid).get();
                        if (doc.exists && doc.data().role === 'admin') {
                            showElementsAfterLogin();
                        } else {
                            window.location.href = 'dashboard.html'; // Redireciona para a página padrão
                        }
                    } catch (error) {
                        console.error('Erro ao obter documento:', error);
                    }
                } else {
                    window.location.href = 'index.html'; // Redireciona para a página de login se não estiver autenticado
                }
            });
        });
    </script>
</body>
</html>